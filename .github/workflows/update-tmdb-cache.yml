name: Update TMDB Cache

"on":
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch: {}

jobs:
  update-cache:
    runs-on: ubuntu-latest
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      SUPABASE_BUCKET: autoflix-media-cache
      SUPABASE_S3_ENDPOINT: ${{ secrets.SUPABASE_S3_ENDPOINT }}
      AWS_ACCESS_KEY_ID: ${{ secrets.SUPABASE_S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.SUPABASE_S3_SECRET_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.SUPABASE_S3_REGION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build cache payloads
        run: |
          node <<'NODE'
          const fs = require('fs');
          const fetch = global.fetch;
          const TMDB_API_BASE = 'https://api.themoviedb.org/3';
          const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w342';
          const TMDB_API_KEY = process.env.TMDB_API_KEY;
          const PAGE_LIMIT = 10;
          const PAGE_SIZE = 18;

          async function mapPage(type, page) {
            const listRes = await fetch(`${TMDB_API_BASE}/trending/${type}/week?api_key=${TMDB_API_KEY}&page=${page}`);
            const listJson = await listRes.json();
            if (!listJson || !listJson.results) return [];
            const results = listJson.results.slice(0, PAGE_SIZE);
            const mapped = await Promise.all(results.map(async (item) => {
              const id = item.id;
              const extRes = await fetch(`${TMDB_API_BASE}/${type}/${id}/external_ids?api_key=${TMDB_API_KEY}`);
              const extJson = await extRes.json();
              if (!extJson || !extJson.imdb_id) return null;
              return {
                Title: type === 'tv' ? item.name : item.title,
                Year: (type === 'tv' ? item.first_air_date : item.release_date || '').split('-')[0] || 'N/A',
                Poster: item.poster_path ? `${TMDB_IMAGE_BASE}${item.poster_path}` : '',
                imdbID: extJson.imdb_id
              };
            }));
            return mapped.filter(Boolean);
          }

          async function buildPayload(type) {
            const formatter = new Intl.DateTimeFormat('en-GB', {
              day: '2-digit',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            });
            const formattedTimestamp = formatter.format(new Date()).replace(',', ' |');
            const pages = {};
            for (let page = 1; page <= PAGE_LIMIT; page++) {
              pages[String(page)] = await mapPage(type, page);
            }
            return {
              type,
              generatedAt: formattedTimestamp,
              pages
            };
          }

          (async () => {
            if (!TMDB_API_KEY) {
              throw new Error('Missing TMDB_API_KEY');
            }
            const moviesPayload = await buildPayload('movie');
            const tvPayload = await buildPayload('tv');
            fs.writeFileSync('latest-movies.json', JSON.stringify(moviesPayload, null, 2));
            fs.writeFileSync('latest-tv.json', JSON.stringify(tvPayload, null, 2));
          })();
          NODE

      - name: Upload to Supabase Storage
        run: |
          aws s3 cp latest-movies.json s3://$SUPABASE_BUCKET/latest-movies.json --endpoint-url "$SUPABASE_S3_ENDPOINT"
          aws s3 cp latest-tv.json s3://$SUPABASE_BUCKET/latest-tv.json --endpoint-url "$SUPABASE_S3_ENDPOINT"
