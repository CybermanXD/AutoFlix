name: Update TMDB Cache

"on":
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch: {}

jobs:
  update-cache:
    runs-on: ubuntu-latest
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      SUPABASE_BUCKET: autoflix-media-cache
      SUPABASE_S3_ENDPOINT: ${{ secrets.SUPABASE_S3_ENDPOINT }}
      AWS_ACCESS_KEY_ID: ${{ secrets.SUPABASE_S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.SUPABASE_S3_SECRET_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.SUPABASE_S3_REGION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build cache payloads
        run: |
          node <<'NODE'
          const fs = require('fs');
          const fetch = global.fetch;
          const TMDB_API_BASE = 'https://api.themoviedb.org/3';
          const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w342';
          const TMDB_API_KEY = process.env.TMDB_API_KEY;
          const PAGE_LIMIT = 80;
          const ANIME_PAGE_LIMIT = 80;
          const PAGE_SIZE = 18;

          async function mapPage(type, page) {
            let listRes;
            if (type === 'anime') {
              listRes = await fetch(`${TMDB_API_BASE}/discover/tv?api_key=${TMDB_API_KEY}&with_genres=16&with_original_language=ja&vote_count.gte=50&sort_by=first_air_date.desc&page=${page}`);
            } else {
              listRes = await fetch(`${TMDB_API_BASE}/trending/${type}/week?api_key=${TMDB_API_KEY}&page=${page}`);
            }
            const listJson = await listRes.json();
            if (!listJson || !listJson.results) return [];
            const results = listJson.results.slice(0, PAGE_SIZE);
            const mapped = await Promise.all(results.map(async (item) => {
              const id = item.id;
              const detailType = type === 'anime' ? 'tv' : type;
              const extRes = await fetch(`${TMDB_API_BASE}/${detailType}/${id}/external_ids?api_key=${TMDB_API_KEY}`);
              const extJson = await extRes.json();
              if (!extJson || !extJson.imdb_id) return null;
              const detailRes = await fetch(`${TMDB_API_BASE}/${detailType}/${id}?api_key=${TMDB_API_KEY}`);
              const detailJson = await detailRes.json();
              const genres = detailJson && detailJson.genres ? detailJson.genres.map(g => g.name).join(', ') : '';
              const releaseDate = type === 'tv' || type === 'anime' ? item.first_air_date : item.release_date;
              return {
                Title: type === 'tv' || type === 'anime' ? item.name : item.title,
                Year: (type === 'tv' || type === 'anime' ? item.first_air_date : item.release_date || '').split('-')[0] || 'N/A',
                ReleaseDate: releaseDate || '',
                Poster: item.poster_path ? `${TMDB_IMAGE_BASE}${item.poster_path}` : '',
                imdbID: extJson.imdb_id,
                Genres: genres,
                tmdbId: id,
                mediaType: detailType,
                useTmdb: type === 'anime'
              };
            }));
            return mapped.filter(Boolean);
          }

          async function buildPayload(type) {
            const formatter = new Intl.DateTimeFormat('en-GB', {
              day: '2-digit',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true,
              timeZone: 'Asia/Kolkata'
            });
            const formattedTimestamp = `${formatter.format(new Date()).replace(',', ' |')} IST`;
            const pages = {};
            const pageLimit = type === 'anime' ? ANIME_PAGE_LIMIT : PAGE_LIMIT;
            for (let page = 1; page <= pageLimit; page++) {
              pages[String(page)] = await mapPage(type, page);
            }
            return {
              type,
              generatedAt: formattedTimestamp,
              pages
            };
          }

          (async () => {
            if (!TMDB_API_KEY) {
              throw new Error('Missing TMDB_API_KEY');
            }
            const moviesPayload = await buildPayload('movie');
            const tvPayload = await buildPayload('tv');
            const animePayload = await buildPayload('anime');
            fs.writeFileSync('latest-movies.json', JSON.stringify(moviesPayload, null, 2));
            fs.writeFileSync('latest-tv.json', JSON.stringify(tvPayload, null, 2));
            fs.writeFileSync('latest-anime.json', JSON.stringify(animePayload, null, 2));
          })();
          NODE

      - name: Upload to Supabase Storage
        run: |
          aws s3 cp latest-movies.json s3://$SUPABASE_BUCKET/latest-movies.json --endpoint-url "$SUPABASE_S3_ENDPOINT"
          aws s3 cp latest-tv.json s3://$SUPABASE_BUCKET/latest-tv.json --endpoint-url "$SUPABASE_S3_ENDPOINT"
          aws s3 cp latest-anime.json s3://$SUPABASE_BUCKET/latest-anime.json --endpoint-url "$SUPABASE_S3_ENDPOINT"
